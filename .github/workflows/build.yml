name: å»ºç½® Windows EXE

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'  # ç•¶æ¨é€ç‰ˆæœ¬æ¨™ç±¤æ™‚è§¸ç™¼ï¼ˆä¾‹å¦‚ v1.0.0ï¼‰
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼
  release:
    types: [published]  # ç•¶ç™¼å¸ƒæ–°ç‰ˆæœ¬æ™‚è§¸ç™¼

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write  # éœ€è¦å¯«å…¥æ¬Šé™ä¾†å‰µå»º Release
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      
    - name: è¨­å®š Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        
    - name: å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: æ¸…é™¤èˆŠçš„å»ºç½®æª”æ¡ˆ
      run: |
        if (Test-Path build) { Remove-Item -Recurse -Force build }
        if (Test-Path dist) { Remove-Item -Recurse -Force dist }
        if (Test-Path english_learning.spec) { Remove-Item -Force english_learning.spec }
        
    - name: ä½¿ç”¨ PyInstaller æ‰“åŒ…
      run: |
        python -m PyInstaller --noconfirm --onefile --name english_learning --add-data "templates;templates" --add-data "static;static" run.py
        
    - name: è¤‡è£½ JSON è³‡æ–™æª”
      run: |
        if (Test-Path word_banks.json) { Copy-Item word_banks.json dist\ }
        if (Test-Path user_data.json) { Copy-Item user_data.json dist\ }
        if (Test-Path bookmarks.json) { Copy-Item bookmarks.json dist\ }
        if (Test-Path subtitle_cache.json) { Copy-Item subtitle_cache.json dist\ }
        if (Test-Path translation_cache.json) { Copy-Item translation_cache.json dist\ }
        
    - name: å¾ CHANGELOGã€Git Tag æˆ– Release å–å¾—ç‰ˆæœ¬è™Ÿ
      id: get_version
      run: |
        if ($env:GITHUB_EVENT_NAME -eq 'release') {
          # å¾ release äº‹ä»¶å–å¾—ç‰ˆæœ¬è™Ÿ
          $RELEASE_JSON = Get-Content $env:GITHUB_EVENT_PATH -Raw | ConvertFrom-Json
          $VERSION = $RELEASE_JSON.release.tag_name -replace '^v', ''
          echo "å¾ Release äº‹ä»¶å–å¾—ç‰ˆæœ¬è™Ÿ: $VERSION"
        } elseif ($env:GITHUB_REF -like 'refs/tags/v*') {
          # å¾ git tag å–å¾—ç‰ˆæœ¬è™Ÿï¼ˆä¾‹å¦‚ v1.0.0 -> 1.0.0ï¼‰
          $VERSION = $env:GITHUB_REF -replace 'refs/tags/v', ''
          echo "å¾ Git Tag å–å¾—ç‰ˆæœ¬è™Ÿ: $VERSION"
        } else {
          # å¾ CHANGELOG.md å–å¾—æœ€æ–°ç‰ˆæœ¬è™Ÿ
          $CHANGELOG = Get-Content CHANGELOG.md -Raw
          if ($CHANGELOG -match '## \[(\d+\.\d+\.\d+)\]') {
            $VERSION = $matches[1]
            echo "å¾ CHANGELOG å–å¾—ç‰ˆæœ¬è™Ÿ: $VERSION"
          } else {
            # å¦‚æœéƒ½æ‰¾ä¸åˆ°ï¼Œä½¿ç”¨é è¨­ç‰ˆæœ¬è™Ÿ
            $VERSION = "1.0.0"
            echo "ä½¿ç”¨é è¨­ç‰ˆæœ¬è™Ÿ: $VERSION"
          }
        }
        echo "VERSION=$VERSION" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        "version=$VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        
    - name: é‡å‘½ååŸ·è¡Œæª”ï¼ˆåŠ ä¸Šç‰ˆæœ¬è™Ÿï¼‰
      run: |
        if (Test-Path dist\english_learning.exe) {
          $VERSION = "${{ steps.get_version.outputs.version }}"
          Rename-Item -Path dist\english_learning.exe -NewName "english_learning-$VERSION.exe"
          echo "å·²é‡å‘½åç‚º: english_learning-$VERSION.exe"
        }
        
    - name: ä¸Šå‚³å»ºç½®ç”¢ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: english-learning-exe
        path: dist/english_learning-*.exe
        retention-days: 30
        
    - name: ä¸Šå‚³æ‰€æœ‰ dist æª”æ¡ˆï¼ˆåŒ…å« JSONï¼‰
      uses: actions/upload-artifact@v4
      with:
        name: english-learning-dist
        path: dist/*
        retention-days: 30
        
    - name: ä¸Šå‚³æª”æ¡ˆåˆ°ç¾æœ‰ Releaseï¼ˆç•¶é€é release äº‹ä»¶è§¸ç™¼æ™‚ï¼‰
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: dist/english_learning-*.exe
        tag_name: ${{ github.event.release.tag_name }}
        draft: false
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: å‰µå»ºæ–°çš„ GitHub Releaseï¼ˆç•¶æ¨é€ä»£ç¢¼æˆ–æ¨™ç±¤æ™‚ï¼‰
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
      uses: softprops/action-gh-release@v1
      with:
        files: dist/english_learning-*.exe
        tag_name: v${{ steps.get_version.outputs.version }}
        name: Release v${{ steps.get_version.outputs.version }}
        body: |
          ## è‹±æ–‡å­¸ç¿’ç³»çµ± v${{ steps.get_version.outputs.version }}
          
          ### ğŸ“¦ ä¸‹è¼‰
          - **english_learning-${{ steps.get_version.outputs.version }}.exe** - Windows å¯åŸ·è¡Œæª”
          
          ### ğŸ“ æ›´æ–°å…§å®¹
          è«‹æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) äº†è§£è©³ç´°æ›´æ–°å…§å®¹ã€‚
          
          ### ğŸš€ ä½¿ç”¨æ–¹å¼
          1. ä¸‹è¼‰ `english_learning-${{ steps.get_version.outputs.version }}.exe`
          2. é›™æ“ŠåŸ·è¡Œå³å¯ä½¿ç”¨
          3. ç¨‹å¼æœƒè‡ªå‹•åœ¨ç€è¦½å™¨é–‹å•Ÿ http://localhost:5000
        draft: false
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}

